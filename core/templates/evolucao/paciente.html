{% extends "base.html" %}
{% block title %}Evolução — {{ paciente.nome }}{% endblock %}

{% block content %}
<div class="vstack gap-3">
  <div class="card shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-start">
      <div>
        <div class="h5 fw-bold mb-1">Evolução do Paciente</div>
        <div class="text-secondary small">
          <strong>{{ paciente.nome }}</strong>
          {% if paciente.hospital %} • {{ paciente.hospital.nome }}{% endif %}
        </div>
      </div>
      <a href="{% url 'producao_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>
  </div>

  <!-- Cards (cada um será atualizado OOB após salvar modal) -->
  <div id="card-observacao">
    {% include 'evolucao/_card_observacao.html' %}
  </div>

  <div id="card-acesso">
    {% include 'evolucao/_card_acesso.html' %}
  </div>

  <div id="card-conduta">
    {% include 'evolucao/_card_conduta.html' %}
  </div>

  <div id="card-producao">
    {% include 'evolucao/_card_producao.html' %}
  </div>
</div>

<!-- Modal base -->
<div class="modal fade" id="modal-lg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content"><!-- HTMX injeta aqui --></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Abrir modal automaticamente quando o conteúdo chega
  document.body.addEventListener('htmx:afterOnLoad', function(evt){
    const modalEl = document.getElementById('modal-lg');
    if (evt.detail.target.closest('#modal-lg')) {
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }
  });
  // Fechar modal quando vier um OOB update (indicando sucesso)
  document.body.addEventListener('htmx:oobAfterSwap', function(evt){
    if (evt.target.id && evt.target.id.startsWith('card-')) {
      const modalEl = document.getElementById('modal-lg');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.hide();
    }
  });
</script>
{% endblock %}
